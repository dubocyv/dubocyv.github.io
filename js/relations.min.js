if(void 0===arisBaseUrl)var arisBaseUrl="http://www.aris.ep.parl.union.eu/#default/item/c.system.";if(void 0===f1Header)var f1Header="ARES name";if(void 0===f2Header)var f2Header="ARES Dept (full)";if(void 0===f3Header)var f3Header="ARES Dept";var root,canvasWidth,canvasHeight,stack=[],nodesList=[],dragMoved=!1,synCircleRadius=8,gridResolution=10,gridCoarseFactor=4,synopticMode=!arisBaseUrl,isIE=!!document.documentMode;function openInNewTab(e){window.open(e,"_blank").focus()}function setCursorByID(e,t){var n;document.getElementById&&(n=document.getElementById(e))&&n.style&&(n.style.cursor=t)}function popupDialog(e,t){var n=cmdbUrl+encodeURIComponent(e.name);null!=d3.event.returnValue&&d3.event.defaultPrevented||($("#dialog").length?($("#dialog").dialog({close:function(){document.getElementById("cmdbInfo").src=""},position:{my:"center",at:"center",of:window},width:900,height:600,title:'"'+e.name+'"'}).dialogExtend({closable:!0,maximizable:!0,minimizable:!0,minimizeLocation:"left",collapsable:!1,dblclick:"collapse"}),isIE?(window.frames.cmdbInfo.document.body.style.cursor="wait",window.frames.cmdbInfo.document.body.style.color="blue",window.frames.cmdbInfo.document.body.innerHTML="Loading..."):(window.frames[0].document.body.style.cursor="wait",window.frames[0].document.body.style.color="blue",window.frames[0].document.body.innerHTML="Loading..."),isIE?document.getElementById("cmdbInfo").src=n:!t||(document.getElementById("cmdbInfo").src=n),$("#dialog").dialog("open")):openInNewTab(n))}$.extend({getUrlVars:function(){for(var e,t=[],n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),r=0;r<n.length;r++)e=n[r].split("="),t.push(e[0]),t[e[0]]=e[1];return t},getUrlVar:function(e){return $.getUrlVars()[e]}}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),d3.text(csvFile,function(e,t){if(e)throw e;if(void 0===root&&(root=$.getUrlVar("root")),void 0!==root&&root.length){root=decodeURIComponent(root.replace(/\+|%20/g," "));var n=d3.dsvFormat(";").parseRows(t),r=[];n.forEach(function(e,t){e[3].length&&(e[1].length||e[2].length)&&r.push({prj:e[0],sendTo:e[1].split(","),recvFrom:e[2].split(","),sizeTo:e[1].split(",").length,sizeFrom:e[2].split(",").length,ID:synopticMode?"id_"+t:e[3].replace(/\s|=|;|,|\(|\)|\[|\]|\&/g,"_"),f1:e[4],f2:e[5],f3:e[6]})}),function e(t){var n=[],c=[],u=[],f=0,g=null;function p(e){for(var t=e.toLowerCase(),n=0;n<r.length;n++){if(r[n].prj.toLowerCase()===t)return r[n];if(r[n].prj.toLowerCase().match(/ project$/)&&r[n].prj.slice(0,r[n].prj.length-8).toLowerCase()===t)return r[n]}}function m(e){for(var t=0;t<c.length;t++)if(c[t]===e)return!0;return!1}function v(e,t){for(var r=0;r<n.length;r++)if(n[r].source===e&&n[r].target===t)return!0;return!1}function h(e){for(var t,n,r=arguments,o=r.length;o>1&&e.length;)for(t=r[--o];-1!==(n=e.indexOf(t));)e.splice(n,1);return e}$(document).ready(function(){$("span.HE").click(function(){e($(this).text())})});var y=p(t);if(null!=y){t=y.prj,h(stack,t),stack.push(t),function(){for(var e="",t=0;t<stack.length;t++)e.length&&(e+=" &rarr; "),t==stack.length-1?e+="<span class='current'>"+stack[t]+"</span>":e+="<span class='HE'>"+stack[t]+"</span>";document.getElementById("history").innerHTML=e}();for(var x=!y.prj.startsWith("@"),k=0;k<y.sendTo.length;k++)y.sendTo[k].length&&!v(y.prj,y.sendTo[k])&&y.prj!=y.sendTo[k]&&(n.push({source:y.prj,target:y.sendTo[k],type:x?"directTo":""}),m(y.sendTo[k])||c.push(y.sendTo[k]));for(k=0;k<y.recvFrom.length;k++)y.recvFrom[k].length&&!v(y.recvFrom[k],y.prj)&&y.prj!=y.recvFrom[k]&&(n.push({source:y.recvFrom[k],target:y.prj,type:x?"directFrom":""}),m(y.recvFrom[k])||c.push(y.recvFrom[k]));for(k=0;k<c.length-1;k++)for(var w=k+1;w<c.length;w++)if(null!=(y=p(c[w]))){for(var L=0;L<y.recvFrom.length;L++)y.recvFrom[L]!==c[k]||v(c[w],c[k])||n.push({source:c[k],target:c[w],type:x?"secondary":"directTo"});for(L=0;L<y.sendTo.length;L++)y.sendTo[L]!==c[k]||v(c[w],c[k])||n.push({source:c[w],target:c[k],type:x?"secondary":"directTo"})}nodesList=[],n.forEach(function(e){e.source=u[e.source]||(u[e.source]={name:e.source,ID:o(e.source),sizeFrom:a(e.source),sizeTo:i(e.source),f1:s(e.source),f2:d(e.source),f3:l(e.source)}),e.target=u[e.target]||(u[e.target]={name:e.target,ID:o(e.target),sizeFrom:a(e.target),sizeTo:i(e.target),f1:s(e.target),f2:d(e.target),f3:l(e.target)})}),$("#prj-container").length&&($(document).ready(function(){$("div.NL").mouseover(function(){for(var e=0;e<nodesList.length;e++)$(this).text()===nodesList[e].name&&S(nodesList[e])}).mouseout(function(){for(var e=0;e<nodesList.length;e++)$(this).text()===nodesList[e].name&&U(nodesList[e])}).click(function(t){if(1==++f){var n=$(this).text();g=setTimeout(function(){f=0,e(n)},350)}else clearTimeout(g),f=0,e($(this).text())}).dblclick(function(e){e.preventDefault()})}),n.forEach(function(e){e.source.name!=t&&(h(nodesList,e.source),nodesList.push(e.source)),e.target.name!=t&&(h(nodesList,e.target),nodesList.push(e.target))}),nodesList.sort(function(e,t){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n<r?-1:n>r?1:0}),function(){for(var e="<div class=flex-cont-prj>",n=0;n<nodesList.length;n++)t===nodesList[n].name?e+="<div class='flex-item-prj target "+nodesList[n].ID+"'>"+nodesList[n].name+"</div>":nodesList[n].ID.length?e+="<div class='flex-item-prj'><div class='NL "+nodesList[n].ID+"'>"+nodesList[n].name+"</div> <div class=nodeDescr>"+nodesList[n].f1+"</div></div>":e+="<div class='flex-item-prj noref'>"+nodesList[n].name+"</div>";e+="</div>",document.getElementById("prj-container").innerHTML=e}()),d3.select("svg").remove();var I=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||document.body.offsetWidth,b=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||document.body.offsetHeight;canvasWidth=I<<1,canvasHeight=b<<1;var D=d3.layout.force().nodes(d3.values(u)).links(n).size([I,b]).linkDistance(175).linkStrength(.7).friction(.9).charge(-3500).gravity(synopticMode?.2:.6).on("start",setCursorByID("tree-container","progress")).on("tick",W).start(),T=d3.behavior.zoom().scaleExtent([.33,5]).on("zoom",function(){M.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}),E=d3.behavior.drag().on("dragstart",function(e,t){dragMoved=!1,D.stop(),d3.selectAll(d3.event.sourceEvent.ctrlKey?".grid":".largeGrid").style("display","inherit")}).on("drag",function(e,t){var n=T.scale()*d3.event.sourceEvent.ctrlKey?1:gridCoarseFactor,r=gridResolution*n,o=d3.event.x,a=d3.event.y,i=B(Math.max(-canvasWidth+synCircleRadius,Math.min((canvasWidth<<1)-synCircleRadius,o)),r),s=B(Math.max(-canvasHeight+synCircleRadius,Math.min((canvasHeight<<1)-synCircleRadius,a)),r);e.x=i,e.y=s,e.px=i,e.py=s,dragMoved=!0,d3.selectAll("line").style("display","none"),d3.selectAll(d3.event.sourceEvent.ctrlKey?".grid":".largeGrid").style("display","inherit"),W()}).on("dragend",function(e,t){dragMoved?e.fixed=!0:e.fixed^=!0,d3.selectAll("line").style("display","none"),document.getElementsByClassName(e.ID).fixed=e.fixed,M.select("."+e.ID).classed("fixed",e.fixed),W(),D.resume()}),M=d3.select("#tree-container").append("svg").attr("width",canvasWidth).attr("height",canvasHeight).call(T).append("svg:g");if($("#dialog").length&&$("#dialog").dialog({autoOpen:!1}),synopticMode){var z=M.append("g");z.selectAll(".vertical").data(d3.range(-Math.round(canvasWidth/gridResolution),Math.round((canvasWidth<<1)/gridResolution))).enter().append("line").attr("class",function(e){return e%gridCoarseFactor?"grid vertical":"grid vertical largeGrid verticalL"}).attr("x1",function(e){return e*gridResolution}).attr("y1",-canvasHeight).attr("x2",function(e){return e*gridResolution}).attr("y2",canvasHeight<<1),z.selectAll(".horizontal").data(d3.range(-Math.round(canvasHeight/gridResolution),Math.round((canvasHeight<<1)/gridResolution))).enter().append("line").attr("class",function(e){return e%gridCoarseFactor?"grid horizontal":"grid horizontal largeGrid horizontalL"}).attr("x1",-canvasWidth).attr("y1",function(e){return e*gridResolution}).attr("x2",canvasWidth<<1).attr("y2",function(e){return e*gridResolution})}M.append("defs").selectAll("marker").data(["directTo","directFrom","secondary"]).enter().append("marker").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",35).attr("refY",-1).attr("markerWidth",synopticMode?9:5).attr("markerHeight",synopticMode?9:5).attr("orient","auto").append("path").attr("d","M0,-3L10,0L0,3");var H=M.append("g").selectAll("path").data(D.links()).enter().append("path").attr("class",function(e){return"link "+e.type}).attr("marker-end",function(e){return"url(#"+e.type+")"});H.append("svg:title").text(function(e){return e.type?"Source: "+e.source.name+" ("+e.source.f1+")\n\nTarget: "+e.target.name+" ("+e.target.f1+")":void 0});var j=M.append("g").selectAll("circle").data(D.nodes()).enter().append("circle").attr("class",function(e){if(e.name===t)return x?"target":"invisible";for(var n=0;n<r.length;n++)if(e.name===r[n].prj)return"ref "+e.ID;return"noref"}).attr("r",synopticMode?synCircleRadius:function(e){return e.sizeFrom+e.sizeTo>0?4+Math.log(e.sizeFrom+e.sizeTo>>1):4}).on("mouseover",S).on("mouseout",U).on("click",K).on("dblclick",V).on("mousedown",function(){d3.event.stopPropagation()}).call(synopticMode?E:D.drag);j.append("svg:title").text(function(e){if(e.sizeFrom||e.sizeTo){var t="";return""!=e.f1&&(t+="\n"+f1Header+": "+e.f1),""!=e.f2&&(t+="\n"+f2Header+": "+e.f2),""!=e.f3&&(t+="\n"+f3Header+": "+e.f3),e.name+"\n-------------------------"+t+"\nNumber of relationships: in "+e.sizeFrom+" / out "+e.sizeTo}return""});var C=M.append("g").selectAll("text").data(D.nodes()).enter().append("svg:text").attr("class",function(e){if(e.name===t)return"target";for(var n=0;n<r.length;n++)if(e.name===r[n].prj)return"ref "+e.ID;return"noref"}).attr("x",10).attr("y",".31em").on("mouseover",S).on("mouseout",U).on("click",K).on("dblclick",V).text(function(e){return e.name}),F=M.append("g").selectAll("text").data(D.nodes()).enter().append("svg:text").attr("class","nodeDescr ").attr("x",15).attr("y","1.35em").text(function(e){return e.f1}),R=M.append("g").selectAll("text").data(D.nodes()).enter().append("svg:a").attr("xlink:href",function(e){return e.f2.startsWith("http")?e.f2:""}).attr("target","_blank").append("svg:text").attr("class",function(e){return e.f2.startsWith("http")?"nodeLink a":"nodeDescr "}).attr("x",15).attr("y","20px").text(function(e){return e.f2});d3.select("body").on("keydown",function(){switch(d3.event.keyCode){case 27:$("#dialog").length&&$("#dialog").dialog("close");for(var t=document.getElementsByClassName("nodeLink a"),r=0;r<t.length;r++)t[r].style.fontSize="";D.linkDistance(175).linkStrength(.7).friction(.9).charge(-3500).gravity(synopticMode?.2:.6).alpha(.75).start(),W(),T.scale(1).translate([0,0]),M.transition().duration(500).attr("transform","translate(0,0)scale(1)");break;case 80:for(t=document.getElementsByClassName("nodeLink a"),r=0;r<t.length;r++)t[r].style.fontSize=t[r].style.fontSize.length?d3.event.ctrlKey?"10px":"":"10px";break;case 8:stack.length>1&&(stack.pop(),e(stack.pop()));break;case 83:D.linkDistance(175).linkStrength(.7).friction(.9).charge(-300).gravity(.1).alpha(0).stop(),W();break;case 69:console.log(u,n)}})}function B(e,t){return e%t<t>>1?e-e%t:e+t-e%t}function W(){D.alpha()<.02&&setCursorByID("tree-container","default"),isIE&&H.each(function(){this.parentNode.insertBefore(this,this)}),H.attr("d",A),j.attr("transform",N),C.attr("transform",N),F.attr("transform",N),R.attr("transform",N)}function A(e){var t=e.target.x-e.source.x,n=e.target.y-e.source.y,r=Math.sqrt(t*t+n*n);return r*=synopticMode?4:1,"M"+e.source.x+","+e.source.y+"A"+r+","+r+" 0 0,1 "+e.target.x+","+e.target.y}function N(e){return"translate("+e.x+","+e.y+")"}function S(e){if(""!==e.ID)for(var t=document.getElementsByClassName(e.ID),n=0;n<t.length;n++)"circle"===t[n].tagName?(t[n].style.fill="yellow",t[n].style.stroke="red",t[n].style.strokeOpacity=.6):(t[n].style.color="red",t[n].style.fill="red",t[n].style.textDecoration="underline")}function U(e){if(""!==e.ID)for(var t=document.getElementsByClassName(e.ID),n=0;n<t.length;n++)t[n].style.fill="",t[n].style.fontWeight="",t[n].style.textDecoration="",t[n].style.stroke="",t[n].style.strokeOpacity="",t[n].style.color=""}function K(n){if(null==d3.event.returnValue||!d3.event.defaultPrevented){if(d3.event.ctrlKey&&d3.event.shiftKey)return popupDialog(n,1),d3.event.preventDefault(),void(d3.event.returnValue=!1);if(d3.event.ctrlKey&&d3.event.altKey||d3.event.altKey)openInNewTab(arisBaseUrl+n.ID+".-1");else{if(n.name===t)return;d3.event.ctrlKey?openInNewTab("?root="+encodeURIComponent(n.name)):d3.event.shiftKey&&e(n.name)}}}function V(n){null!=d3.event.returnValue&&d3.event.defaultPrevented||n.name!==t&&e(n.name)}}(root)}function o(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].ID;return""}function a(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].sizeFrom;return""}function i(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].sizeTo;return""}function s(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].f1;return""}function d(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].f2;return""}function l(e){for(var t=0;t<r.length;t++)if(r[t].prj===e)return r[t].f3;return""}});